{% extends "base.html" %}

{% block title %}Discovery - HA Intelligence Hub{% endblock %}
{% block nav_discovery %}active{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Discovery</h2>
    <p>Live inventory of your Home Assistant instance</p>
</div>

<!-- Summary Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ entity_count }}</div>
        <div class="stat-label">Entities</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ device_count }}</div>
        <div class="stat-label">Devices</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ area_count }}</div>
        <div class="stat-label">Areas</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ capability_count }}</div>
        <div class="stat-label">Capabilities</div>
    </div>
    <div class="stat-card {% if unavailable_count > 100 %}stat-warning{% endif %}">
        <div class="stat-value">{{ unavailable_count }}</div>
        <div class="stat-label">Unavailable</div>
    </div>
</div>

<!-- Domain Breakdown -->
<div class="card">
    <h3>Domain Breakdown</h3>
    <div class="domain-bars">
        {% for item in domain_breakdown %}
        <div class="domain-bar-row">
            <span class="domain-bar-label">{{ item.domain }}</span>
            <div class="domain-bar-track">
                <div class="domain-bar-fill" style="width: {{ (item.count / entity_count * 100) | round(1) }}%"></div>
            </div>
            <span class="domain-bar-count">{{ item.count }}</span>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Areas with Entity Counts -->
<div class="card" x-data="{ expanded: false }">
    <h3>
        Areas
        <button class="btn-toggle" @click="expanded = !expanded" x-text="expanded ? 'Collapse' : 'Expand'"></button>
    </h3>
    <div class="area-grid">
        {% for area_id, area in areas.items() %}
        <div class="area-card">
            <div class="area-name">{{ area.name or area_id }}</div>
            <div class="area-entity-count">{{ area_entity_counts.get(area_id, 0) }} entities</div>
        </div>
        {% endfor %}
        {% if not areas %}
        <p class="empty-state">No areas found</p>
        {% endif %}
    </div>
</div>

<!-- Entity Browser -->
<div class="card" x-data="{
    entities: {{ entities | tojson }},
    devices: {{ devices | tojson }},
    areas: {{ areas | tojson }},
    searchTerm: '',
    domainFilter: '',
    stateFilter: '',
    areaFilter: '',
    showCount: 50,
    get filteredEntities() {
        let filtered = Object.entries(this.entities);

        if (this.searchTerm) {
            const term = this.searchTerm.toLowerCase();
            filtered = filtered.filter(([id, entity]) =>
                id.toLowerCase().includes(term) ||
                (entity.friendly_name && entity.friendly_name.toLowerCase().includes(term)) ||
                (entity.device_class && entity.device_class.toLowerCase().includes(term)) ||
                (entity.area_id && entity.area_id.toLowerCase().includes(term))
            );
        }

        if (this.domainFilter) {
            filtered = filtered.filter(([id, entity]) =>
                id.startsWith(this.domainFilter + '.')
            );
        }

        if (this.stateFilter === 'unavailable') {
            filtered = filtered.filter(([id, entity]) =>
                entity.state === 'unavailable' || entity.state === 'unknown'
            );
        } else if (this.stateFilter === 'on') {
            filtered = filtered.filter(([id, entity]) => entity.state === 'on');
        } else if (this.stateFilter === 'off') {
            filtered = filtered.filter(([id, entity]) => entity.state === 'off');
        }

        if (this.areaFilter) {
            filtered = filtered.filter(([id, entity]) =>
                entity.area_id === this.areaFilter
            );
        }

        return filtered;
    },
    get displayedEntities() {
        return this.filteredEntities.slice(0, this.showCount);
    },
    get domains() {
        const domainSet = new Set();
        Object.keys(this.entities).forEach(id => {
            domainSet.add(id.split('.')[0]);
        });
        return Array.from(domainSet).sort();
    },
    get areaList() {
        return Object.entries(this.areas).map(([id, a]) => ({id, name: a.name || id})).sort((a,b) => a.name.localeCompare(b.name));
    },
    getAreaName(areaId) {
        if (!areaId) return '';
        const area = this.areas[areaId];
        return area ? (area.name || areaId) : areaId;
    },
    getDeviceName(deviceId) {
        if (!deviceId) return '';
        const device = this.devices[deviceId];
        return device ? (device.name || deviceId) : '';
    }
}">
    <h3>Entity Browser <span class="badge" x-text="filteredEntities.length + ' / ' + Object.keys(entities).length"></span></h3>

    <!-- Filters -->
    <div class="filters">
        <input
            type="text"
            x-model.debounce.200ms="searchTerm"
            placeholder="Search name, ID, device class, area..."
            class="search-input"
        >
        <select x-model="domainFilter" class="filter-select">
            <option value="">All domains</option>
            <template x-for="domain in domains" :key="domain">
                <option :value="domain" x-text="domain"></option>
            </template>
        </select>
        <select x-model="stateFilter" class="filter-select">
            <option value="">All states</option>
            <option value="on">On</option>
            <option value="off">Off</option>
            <option value="unavailable">Unavailable/Unknown</option>
        </select>
        <select x-model="areaFilter" class="filter-select">
            <option value="">All areas</option>
            <template x-for="area in areaList" :key="area.id">
                <option :value="area.id" x-text="area.name"></option>
            </template>
        </select>
    </div>

    <!-- Entity Table -->
    <div class="entity-table-wrap">
        <table class="entity-table">
            <thead>
                <tr>
                    <th>Entity</th>
                    <th>State</th>
                    <th>Domain</th>
                    <th>Class</th>
                    <th>Area</th>
                    <th>Device</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="[entityId, entity] in displayedEntities" :key="entityId">
                    <tr>
                        <td>
                            <div class="entity-cell-name" x-text="entity.friendly_name || entityId"></div>
                            <div class="entity-cell-id" x-text="entityId"></div>
                        </td>
                        <td>
                            <span class="state-badge"
                                  :class="{
                                      'state-on': entity.state === 'on' || entity.state === 'home',
                                      'state-off': entity.state === 'off' || entity.state === 'not_home',
                                      'state-unavailable': entity.state === 'unavailable' || entity.state === 'unknown'
                                  }"
                                  x-text="entity.state"></span>
                            <span class="entity-unit" x-show="entity.unit_of_measurement" x-text="entity.unit_of_measurement"></span>
                        </td>
                        <td><span class="domain-badge" x-text="entity.domain || entityId.split('.')[0]"></span></td>
                        <td x-text="entity.device_class || '—'"></td>
                        <td x-text="getAreaName(entity.area_id) || '—'"></td>
                        <td>
                            <span class="device-name" x-text="getDeviceName(entity.device_id) || '—'"></span>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Load More -->
    <div class="load-more" x-show="filteredEntities.length > showCount">
        <button class="btn-secondary" @click="showCount += 50"
                x-text="'Show more (' + (filteredEntities.length - showCount) + ' remaining)'"></button>
    </div>
    <template x-if="filteredEntities.length === 0">
        <p class="empty-state">No entities match your filters</p>
    </template>
</div>

<!-- Devices -->
<div class="card" x-data="{
    devices: {{ devices | tojson }},
    searchTerm: '',
    showCount: 30,
    get filteredDevices() {
        let filtered = Object.entries(this.devices);
        if (this.searchTerm) {
            const term = this.searchTerm.toLowerCase();
            filtered = filtered.filter(([id, dev]) =>
                (dev.name && dev.name.toLowerCase().includes(term)) ||
                (dev.manufacturer && dev.manufacturer.toLowerCase().includes(term)) ||
                (dev.model && dev.model.toLowerCase().includes(term)) ||
                id.toLowerCase().includes(term)
            );
        }
        return filtered;
    },
    get displayedDevices() {
        return this.filteredDevices.slice(0, this.showCount);
    }
}">
    <h3>Devices <span class="badge" x-text="filteredDevices.length + ' / ' + Object.keys(devices).length"></span></h3>
    <div class="filters">
        <input type="text" x-model.debounce.200ms="searchTerm" placeholder="Search devices..." class="search-input">
    </div>
    <div class="entity-table-wrap">
        <table class="entity-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Manufacturer</th>
                    <th>Model</th>
                    <th>Area</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="[devId, dev] in displayedDevices" :key="devId">
                    <tr>
                        <td>
                            <div class="entity-cell-name" x-text="dev.name || devId"></div>
                            <div class="entity-cell-id" x-text="devId" style="max-width:200px"></div>
                        </td>
                        <td x-text="dev.manufacturer || '—'"></td>
                        <td x-text="dev.model || '—'"></td>
                        <td x-text="dev.area_id || '—'"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>
    <div class="load-more" x-show="filteredDevices.length > showCount">
        <button class="btn-secondary" @click="showCount += 30"
                x-text="'Show more (' + (filteredDevices.length - showCount) + ' remaining)'"></button>
    </div>
</div>
{% endblock %}
